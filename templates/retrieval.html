{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Retrieval</h3>
  <div class="position-relative" style="min-width: 280px; text-align: right;">
    <form id="retrieveForm" style="display: inline;">
      <button id="retrieveBtn" class="btn btn-primary">Fetch Latest From All Servers</button>
    </form>
    <span id="totalOverall" data-total="{{ total_overall or 0 }}" style="display:none"></span>
    <span id="activeJobId" data-job-id="{{ active_job_id or '' }}" style="display:none"></span>
    <div id="loadingIndicator" class="position-absolute end-0" style="top: 50%; transform: translateY(-50%); display:none;">
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      <span class="ms-1">Fetching…</span>
      <div class="small text-muted mt-1" id="progressText"></div>
    </div>
  </div>
  <script>
    (function(){
      const V2_QS = {{ v2_mode_qs | tojson }};
      function withV2(url){
        if(!V2_QS) return url;
        return url.includes('?') ? `${url}&v2=1` : `${url}${V2_QS}`;
      }
      const totalEl = document.getElementById('totalOverall');
      window.TOTAL_OVERALL = totalEl ? parseInt(totalEl.getAttribute('data-total')) || 0 : 0;
      const activeJobIdEl = document.getElementById('activeJobId');
      const form = document.getElementById('retrieveForm');
      const btn = document.getElementById('retrieveBtn');
      const loading = document.getElementById('loadingIndicator');
      const progressText = document.getElementById('progressText');
      let timer = null;

      function setLoading(isLoading) {
        if (btn) {
          btn.style.visibility = isLoading ? 'hidden' : 'visible';
          btn.disabled = !!isLoading;
        }
        if (loading) loading.style.display = isLoading ? 'block' : 'none';
      }

      function renderProgress(payload) {
        const progress = (payload && payload.progress) || {};
        const total = Number(progress.total || window.TOTAL_OVERALL || 0);
        const completed = Number(progress.completed || 0);
        const current = progress.current || '';
        const phase = progress.phase || '';
        let text = `Completed: ${completed}/${total}`;
        if (current) {
          text = phase ? `${text} · Now fetching: ${phase} · ${current}` : `${text} · Now fetching: ${current}`;
        }
        if (progressText) progressText.textContent = text;
      }

      function startPolling(jobId) {
        if (!jobId) return;
        if (timer) clearInterval(timer);
        setLoading(true);
        timer = setInterval(async function(){
          try {
            const res = await fetch(withV2(`/retrieve/status/${encodeURIComponent(jobId)}`));
            if (!res.ok) throw new Error(`status ${res.status}`);
            const payload = await res.json();
            renderProgress(payload);
            const state = payload.state || '';
            if (state !== 'running') {
              clearInterval(timer);
              timer = null;
              window.location.href = withV2(`/retrieve?job_id=${encodeURIComponent(jobId)}&notify=1`);
            }
          } catch (e) {
            if (progressText) progressText.textContent = 'Fetching progress…';
          }
        }, 1000);
      }

      if (form) {
        form.addEventListener('submit', async function(ev){
          ev.preventDefault();
          setLoading(true);
          try {
            const res = await fetch(withV2('/retrieve/start'), { method: 'POST' });
            const payload = await res.json();
            if (!res.ok && res.status !== 409) {
              throw new Error(payload.error || 'Failed to start retrieval');
            }
            const jobId = payload.job_id;
            if (!jobId) throw new Error('Missing job id');
            startPolling(jobId);
          } catch (e) {
            setLoading(false);
            if (progressText) progressText.textContent = '';
            alert(e && e.message ? e.message : 'Failed to start retrieval');
          }
        });
      }

      const activeJobId = activeJobIdEl ? activeJobIdEl.getAttribute('data-job-id') : '';
      if (activeJobId) {
        startPolling(activeJobId);
      }
    })();
  </script>
</div>

{% if master_password_warning %}
  <div class="alert alert-warning py-2">
    {{ master_password_warning }}
  </div>
{% endif %}

<div class="alert alert-info py-2">
  Diagnostic bundles are stored locally to the LRmetrics application. They are not automatically transmitted to any system or entity. Please download them and transfer them manually.
  </div>

{% if results and results|length > 0 %}
  <div class="mb-3">
    <h5 class="mb-2">Fetch Summary</h5>
    <ul class="list-group">
    {% for r in results %}
      {% set name = bundle_labels.get(r.server, r.server) if bundle_labels else r.server %}
      {% if r.error %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              {{ name }}
              {% if r['status'] is defined %}
                <span class="text-muted ms-2">(status {{ r['status'] }})</span>
              {% endif %}
            </div>
            <span class="badge bg-danger">Failed</span>
          </div>
          {% if r['reason'] is defined and r['reason'] %}
            <div class="mt-1 small text-muted">{{ r['reason'] }}</div>
          {% endif %}
          <details class="mt-2">
            <summary class="small">Debug details</summary>
            <pre class="small bg-dark text-light p-2 border rounded">{{ r | tojson }}</pre>
          </details>
        </li>
      {% elif r.diagnostics == 'COMPLETED' %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ name }}
          <span class="badge bg-success">Completed</span>
        </li>
      {% else %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ name }}
          <span class="badge bg-secondary">Started</span>
        </li>
      {% endif %}
    {% endfor %}
    </ul>
  </div>
{% endif %}

<style>
  /* Grid layout to align left/right sections by rows */
  .retrieval-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 16px 24px; align-items: start; }
  .grid-left { grid-column: 1; }
  .grid-right { grid-column: 2; }
  .grid-row-1 { grid-row: 1; }
  .grid-row-2 { grid-row: 2; }
</style>

<div class="retrieval-grid mt-2">
  <div class="grid-left grid-row-1" id="left-bundles">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Lightrun Diagnostics Bundles</h5>
    </div>
    {% for sid, files in bundles.items() %}
      <div class="mb-2">
        <strong>{{ bundle_labels.get(sid, sid) }}</strong>
        <ul>
        {% for f in files[:10] %}
          <li><a href="{{ v2_path('/bundles/' ~ sid ~ '/' ~ f) }}">{{f}}</a></li>
        {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </div>
  <div class="grid-right grid-row-1" id="right-download">
    <a class="btn btn-outline-secondary btn-sm" href="{{ v2_path('/export') }}">Download bundles and summaries</a>
  </div>

  {% if gh_reports and gh_reports|length > 0 %}
    <div class="grid-left grid-row-2" id="left-gh-reports">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-2">GitHub Reports</h5>
      </div>
      {% for rid, files in gh_reports.items() %}
        <div class="mb-3">
          <strong>{{ gh_labels.get(rid, rid) }}</strong>
          <ul>
          {% for f in (files.api or [])[:10] %}
            <li><a href="{{ v2_path('/gh_reports/' ~ rid ~ '/' ~ f) }}">{{f}}</a></li>
          {% endfor %}
          {% for f in (files.cli or [])[:10] %}
            <li><a href="{{ v2_path('/cli_reports/' ~ rid ~ '/' ~ f) }}">{{f}}</a> <span class="text-muted small">(manual)</span></li>
          {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>

    <div class="grid-right grid-row-2" id="right-manual-upload">
      <div class="d-flex align-items-center">
        <h5 class="mb-2">Manual Git Upload</h5>
      </div>
      {% for rid, files in gh_reports.items() %}
        <div class="mb-3">
          <strong>{{ gh_labels.get(rid, rid) }}</strong>
          <div class="mt-2 p-2 border rounded" style="text-align: left;">
            <div class="mb-1">Upload manually retrieved git history (no token required):</div>
            <ol class="mb-2">
              <li>Select your OS, click "Copy command", paste into a terminal at the repo root, run it.</li>
              <li>It generates a text file in your temp folder; upload that file below.</li>
            </ol>
            <div class="d-flex align-items-center gap-2 mb-2">
              <label class="me-2">OS:</label>
              <select class="form-select form-select-sm" id="os-select-{{ rid }}" style="max-width: 160px;">
                <option value="linux">Linux</option>
                <option value="mac">Mac</option>
                <option value="windows">Windows</option>
              </select>
              <button class="btn btn-outline-secondary btn-sm" type="button" onclick="copyGitCmd('{{ rid }}')">Copy command</button>
            </div>
            <div class="form-text" id="cmd-help-{{ rid }}">Command copied to clipboard when you click the button.</div>
            <form method="post" action="{{ v2_path('/upload/git-txt') }}" enctype="multipart/form-data" class="mt-2">
              <input type="hidden" name="repo_id" value="{{ rid }}" />
              <div class="input-group input-group-sm">
                <input type="file" name="file" accept="text/plain" class="form-control" />
                <button class="btn btn-outline-primary btn-sm" type="submit">Upload Git CLI Text</button>
              </div>
            </form>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>
<!-- Simple stacking: download button then manual upload, no JS alignment -->
  <script>
    function copyGitCmd(rid) {
      const sel = document.getElementById('os-select-' + rid);
      const os = sel ? sel.value : 'linux';
      const ts = new Date();
      const pad = n => (n<10?'0':'') + n;
      const tsStr = ts.getFullYear().toString()+pad(ts.getMonth()+1)+pad(ts.getDate())+pad(ts.getHours())+pad(ts.getMinutes())+pad(ts.getSeconds());
      let cmd = '';
      if (os === 'linux' || os === 'mac') {
        cmd = `outfile="/tmp/LRmetrics-git-$(date +%Y%m%d%H%M%S).txt"; git log --since=90.days --name-only --date=iso --pretty="%H|%ad|%an" > "$outfile"; echo $outfile`;
      } else {
        // Windows CMD (locale dependent date/time). If it fails, user can edit filename manually.
        cmd = `set "outfile=%TEMP%\\LRmetrics-git-%DATE:~-4%%DATE:~4,2%%DATE:~7,2%-%TIME:~0,2%%TIME:~3,2%%TIME:~6,2%.txt" && git log --since=90.days --name-only --date=iso --pretty="%H|%ad|%an" > "%outfile%" && echo %outfile%`;
      }
      navigator.clipboard.writeText(cmd).then(()=>{
        const help = document.getElementById('cmd-help-' + rid);
        if (help) help.textContent = 'Command copied. Paste in terminal and run; it will print the output file path.';
      }).catch(()=>{
        alert('Failed to copy. Please copy manually.');
      });
    }
  </script>

{% endblock %}
