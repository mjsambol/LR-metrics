{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Retrieval</h3>
  <div class="position-relative" style="min-width: 280px; text-align: right;">
    <form id="retrieveForm" method="post" style="display: inline;">
      <button id="retrieveBtn" class="btn btn-primary">Fetch Latest From All Servers</button>
    </form>
    <span id="totalOverall" data-total="{{ total_overall or 0 }}" style="display:none"></span>
    <div id="loadingIndicator" class="position-absolute end-0" style="top: 50%; transform: translateY(-50%); display:none;">
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      <span class="ms-1">Fetching…</span>
      <div class="small text-muted mt-1" id="progressText"></div>
    </div>
  </div>
  <script>
    (function(){
      const totalEl = document.getElementById('totalOverall');
      window.TOTAL_OVERALL = totalEl ? parseInt(totalEl.getAttribute('data-total')) || 0 : 0;
      const form = document.getElementById('retrieveForm');
      const btn = document.getElementById('retrieveBtn');
      const loading = document.getElementById('loadingIndicator');
      const progressText = document.getElementById('progressText');
      let timer = null;
      if (form) {
        form.addEventListener('submit', function(){
          if (btn) { btn.style.visibility = 'hidden'; btn.disabled = true; }
          if (loading) loading.style.display = 'block';
          // poll unified server progress once per second
          timer = setInterval(async function(){
            const total = window.TOTAL_OVERALL || 0;
            let completedSum = 0;
            let currentName = '';
            let phaseLabel = '';
            try {
              const res = await fetch('/progress');
              const all = await res.json();
              const lr = all.lightrun || {};
              const gh = all.github || {};
              completedSum += ((lr.completed || []).length + (gh.completed || []).length);
              if (!currentName && lr.current) { currentName = lr.current; phaseLabel = 'Lightrun'; }
              if (!currentName && gh.current) { currentName = gh.current; phaseLabel = 'GitHub'; }
            } catch (e) {}
            let text = `Completed: ${completedSum}/${total}`;
            if (currentName) {
              if (phaseLabel) {
                text = `${text} · Now fetching: ${phaseLabel} · ${currentName}`;
              } else {
                text = `${text} · Now fetching: ${currentName}`;
              }
            }
            if (progressText) progressText.textContent = text;
          }, 1000);
        });
      }
      // When page reloads after POST completes, button becomes visible again
    })();
  </script>
</div>

<div class="alert alert-info py-2">
  Diagnostic bundles are stored locally to the LRmetrics application. They are not automatically transmitted to any system or entity. Please download them and transfer them manually.
  </div>

{% if results and results|length > 0 %}
  <div class="mb-3">
    <h5 class="mb-2">Fetch Summary</h5>
    <ul class="list-group">
    {% for r in results %}
      {% set name = bundle_labels.get(r.server, r.server) if bundle_labels else r.server %}
      {% if r.error %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              {{ name }}
              {% if r['status'] is defined %}
                <span class="text-muted ms-2">(status {{ r['status'] }})</span>
              {% endif %}
            </div>
            <span class="badge bg-danger">Failed</span>
          </div>
          {% if r['reason'] is defined and r['reason'] %}
            <div class="mt-1 small text-muted">{{ r['reason'] }}</div>
          {% endif %}
          <details class="mt-2">
            <summary class="small">Debug details</summary>
            <pre class="small bg-dark text-light p-2 border rounded">{{ r | tojson }}</pre>
          </details>
        </li>
      {% elif r.diagnostics == 'COMPLETED' %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ name }}
          <span class="badge bg-success">Completed</span>
        </li>
      {% else %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
          {{ name }}
          <span class="badge bg-secondary">Started</span>
        </li>
      {% endif %}
    {% endfor %}
    </ul>
  </div>
{% endif %}

<div class="d-flex justify-content-between align-items-center mb-2">
  <h5 class="mb-0">Lightrun Diagnostics Bundles</h5>
  <a class="btn btn-outline-secondary btn-sm" href="/export/bundles">Download all latest bundles as one zip</a>
</div>
{% for sid, files in bundles.items() %}
  <div class="mb-2">
    <strong>{{ bundle_labels.get(sid, sid) }}</strong>
    <ul>
    {% for f in files[:10] %}
      <li><a href="/bundles/{{sid}}/{{f}}">{{f}}</a></li>
    {% endfor %}
    </ul>
  </div>
{% endfor %}

{% if gh_reports and gh_reports|length > 0 %}
  <div class="mt-3">
    <h5 class="mb-2">GitHub Reports</h5>
    {% for rid, files in gh_reports.items() %}
      <div class="mb-2">
        <strong>{{ gh_labels.get(rid, rid) }}</strong>
        <ul>
        {% for f in files[:10] %}
          <li><a href="/gh_reports/{{rid}}/{{f}}">{{f}}</a></li>
        {% endfor %}
        </ul>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% endblock %}
