{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-md-3">
    <h5>Sources</h5>
    <div class="list-group">
      <a href="{{ v2_url('setup', src='lightrun') }}" class="list-group-item list-group-item-action {% if src=='lightrun' %}active{% endif %}">Lightrun Servers</a>
      <a href="{{ v2_url('setup', src='github') }}" class="list-group-item list-group-item-action {% if src=='github' %}active{% endif %}">Github Repositories</a>
      <a href="{{ v2_url('setup', src='jira') }}" class="list-group-item list-group-item-action {% if src=='jira' %}active{% endif %}">Jira Spaces</a>
    </div>
  </div>
  <div class="col-md-9">
    {% if master_password_warning %}
      <div class="alert alert-warning py-2">
        {{ master_password_warning }}
      </div>
    {% endif %}
    {% if src == 'lightrun' %}
      <div class="d-flex justify-content-between align-items-center">
        <h3>Lightrun Servers</h3>
      </div>
      <div class="alert alert-info py-2">
        This configuration information is stored local to the LRmetrics app. Passwords are stored encrypted by your master password, which is never stored. This configuration information is used to retrieve usage information from the target system, and is otherwise never transmitted to any other system.
      </div>
      <div class="row">
        <div class="col-md-6">
          <h5>Add New Server</h5>
          <form id="add-server-form" method="post">
            <div class="mb-3">
              <label class="form-label">Configuration Name</label>
              <input id="input-name" name="name" class="form-control" placeholder="e.g. production-us-east">
              <div class="form-text">This may be the environment or region unique to this server.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Server URL</label>
              <input id="input-url" name="url" class="form-control" placeholder="https://example.lightrun.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Admin Email</label>
              <input id="input-email" name="email" class="form-control" placeholder="admin@example.com">
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input id="input-password" name="password" type="password" class="form-control">
            </div>
            <div class="d-flex gap-2">
              <button id="btn-add-test" type="button" class="btn btn-outline-secondary">Test</button>
              <button id="btn-add-save" class="btn btn-primary" disabled>Save</button>
              <span id="add-test-status" class="align-self-center ms-2"></span>
            </div>
          </form>
        </div>
        <div class="col-md-6">
          <h5>Saved Servers</h5>
          {% if servers %}
            <form id="server-list-form">
              <ul class="list-group">
              {% for s in servers %}
                  <li class="list-group-item d-flex align-items-start" data-server-id="{{ s.id }}">
                  <div class="form-check me-3">
                    <input class="form-check-input select-server" type="radio" name="selected_server" id="srv-{{ loop.index0 }}" value="{{ s.id }}">
                  </div>
                  <div>
                    <div class="fw-bold">{{ s.name }}</div>
                    <div class="small text-muted">{{ s.url }}</div>
                    <div class="small text-muted">{{ s.email }}</div>
                    {% if s.version %}
                      <div class="small text-muted">Version: {{ s.version }}</div>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
              </ul>
            </form>

            <div class="mt-3 mb-2 text-end">
              <button id="btn-edit" class="btn btn-outline-primary me-2" disabled>Edit</button>
              <button id="btn-remove" class="btn btn-outline-danger" disabled>Remove</button>
            </div>

            <!-- hidden delete form -->
            <form id="delete-form" method="post" style="display:none"></form>

          {% else %}
            <div class="text-muted">No servers configured yet.</div>
          {% endif %}
        </div>
      </div>
    {% elif src == 'github' %}
      <div class="d-flex justify-content-between align-items-center">
        <h3>GitHub Repositories</h3>
      </div>
      <div class="alert alert-info py-2">
        Repository credentials (tokens) are stored encrypted by your master password, which is never stored. Only minimal metadata is fetched (commit author, date, and file names), never the diffs themselves.
      </div>
      <div class="row">
        <div class="col-md-6">
          <h5>Add Repository</h5>
          <form id="add-gh-form" method="post">
            <div class="mb-3">
              <label class="form-label">Configuration Name</label>
              <input id="gh-name" name="name" class="form-control" placeholder="e.g. platform-api">
            </div>
            <div class="mb-3">
              <label class="form-label">Repository (owner/repo)</label>
              <input id="gh-full" name="full_name" class="form-control" placeholder="owner/repo">
            </div>
            <div class="mb-3">
              <label class="form-label">API Base URL (optional)</label>
              <input id="gh-api" name="api_base" class="form-control" placeholder="https://api.github.company.com">
              <div class="form-text">Leave empty for public GitHub.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Access Token</label>
              <input id="gh-token" name="token" type="password" class="form-control">
              <div class="form-text">
                Use a fine‑grained PAT with <code>Contents: Read</code>. Create at
                <a href="https://github.com/settings/personal-access-tokens/new" target="_blank" rel="noopener noreferrer">GitHub → Tokens</a>.
              </div>
            </div>
            <div class="d-flex gap-2">
              <button id="btn-gh-test" type="button" class="btn btn-outline-secondary">Test</button>
              <button id="btn-gh-save" class="btn btn-primary" disabled>Save</button>
              <span id="gh-test-status" class="align-self-center ms-2"></span>
            </div>
          </form>
        </div>
        <div class="col-md-6">
          <h5>Saved Repositories</h5>
          {% if servers %}
            <form id="gh-list-form">
              <ul class="list-group">
              {% for s in servers %}
                <li class="list-group-item d-flex align-items-start" data-server-id="{{ s.id }}">
                  <div class="form-check me-3">
                    <input class="form-check-input select-server" type="radio" name="selected_server" id="gh-{{ loop.index0 }}" value="{{ s.id }}">
                  </div>
                  <div>
                    <div class="fw-bold">{{ s.name }}</div>
                    <div class="small text-muted">{{ s.full_name }}</div>
                    {% if s.last_checked %}
                      <div class="small text-muted">Last checked: {{ s.last_checked }}</div>
                    {% endif %}
                  </div>
                </li>
              {% endfor %}
              </ul>
            </form>
            <div class="mt-3 mb-2 text-end">
              <!-- Edit not implemented yet for GitHub -->
              <button id="btn-remove" class="btn btn-outline-danger" disabled>Remove</button>
            </div>
            <form id="delete-form" method="post" style="display:none"></form>
          {% else %}
            <div class="text-muted">No repositories configured yet.</div>
          {% endif %}
        </div>
      </div>
    {% else %}
      <h3 class="mb-3">{{ src|capitalize }} (Not configured yet)</h3>
      <p class="text-muted">Support for {{ src }} will be added shortly.</p>
    {% endif %}
  </div>
</div>

<script>
// Setup page script: selection, edit/remove, and add-form test/save flow
const V2_QS = {{ v2_mode_qs | tojson }};
function withV2(url){
  if(!V2_QS) return url;
  return url.includes('?') ? `${url}&v2=1` : `${url}${V2_QS}`;
}
function selectedServerId(){
  const sel = document.querySelector('input[name="selected_server"]:checked');
  return sel ? sel.value : null;
}

function updateActionButtons(){
  const has = !!selectedServerId();
  document.getElementById('btn-edit').disabled = !has;
  document.getElementById('btn-remove').disabled = !has;
}

function editSelected(){
  const id = selectedServerId();
  if(!id) return;
  window.location.href = withV2(`/setup/edit/{{src}}/${id}`);
}

function removeSelected(){
  const id = selectedServerId();
  if(!id) return;
  if(!confirm('Remove selected server?')) return;
  const form = document.getElementById('delete-form');
  form.action = withV2(`/setup/delete/{{src}}/${id}`);
  form.submit();
}

document.addEventListener('DOMContentLoaded', function(){
  // wire selection
  document.querySelectorAll('.select-server').forEach(function(el){ el.addEventListener('change', updateActionButtons); });
  // wire edit/remove
  document.getElementById('btn-edit')?.addEventListener('click', editSelected);
  document.getElementById('btn-remove')?.addEventListener('click', removeSelected);

  // Lightrun add-form behavior: require successful test before enabling Save
  const addForm = document.getElementById('add-server-form');
  if(addForm){
    addForm.addEventListener('submit', function(ev){
      const saveBtn = document.getElementById('btn-add-save');
      if(saveBtn.disabled){ ev.preventDefault(); alert('Please run Test and ensure it passes before saving.'); }
    });
    document.getElementById('btn-add-test')?.addEventListener('click', async function(){
      const name = document.getElementById('input-name').value.trim();
      const url = document.getElementById('input-url').value.trim();
      const email = document.getElementById('input-email').value.trim();
      const password = document.getElementById('input-password').value;
      const statusEl = document.getElementById('add-test-status');
      statusEl.innerHTML = '';
      if(!name){ alert('Name is required'); return; }
      if(!/^https?:\/\//i.test(url)){ alert('URL must start with http:// or https://'); return; }
      if(!/[^@]+@[^@]+\.[^@]+/.test(email)){ alert('Invalid email'); return; }
      try{
        const fd = new FormData(); fd.append('url', url); fd.append('email', email); fd.append('password', password);
        const res = await fetch(withV2(`/setup/test-params/{{src}}`), {method:'POST', body: fd});
        const j = await res.json();
        if(j.ok){
          let parts = [];
          if(j.version) parts.push(`<small class="text-success ms-1">${j.version}</small>`);
          if(j.auth){
            if(j.auth.ok) parts.push(`<span class="badge bg-success ms-2">Auth OK</span>`);
            else parts.push(`<span class="badge bg-warning ms-2">Auth Failed</span>`);
          }
          statusEl.innerHTML = `<span class="badge bg-success">OK</span> ${parts.join(' ')}`;
          // Only enable Save when authentication also succeeded
          if(j.auth && j.auth.ok){
            document.getElementById('btn-add-save').disabled = false;
          } else {
            document.getElementById('btn-add-save').disabled = true;
          }
        } else {
          statusEl.innerHTML = `<span class="badge bg-danger">Fail</span> <small class="text-danger ms-1">${j.info || j.status || j.error || ''}</small>`;
          document.getElementById('btn-add-save').disabled = true;
        }
      }catch(e){
        statusEl.innerHTML = `<span class="badge bg-danger">Error</span> <small class="text-danger ms-1">${e}</small>`;
        document.getElementById('btn-add-save').disabled = true;
      }
    });
  }
  // GitHub add-form behavior
  const ghForm = document.getElementById('add-gh-form');
  if(ghForm){
    ghForm.addEventListener('submit', function(ev){
      const saveBtn = document.getElementById('btn-gh-save');
      if(saveBtn.disabled){ ev.preventDefault(); alert('Please run Test and ensure it passes before saving.'); }
    });
    document.getElementById('btn-gh-test')?.addEventListener('click', async function(){
      const name = document.getElementById('gh-name').value.trim();
      const full = document.getElementById('gh-full').value.trim();
      const token = document.getElementById('gh-token').value;
      const api = document.getElementById('gh-api').value.trim();
      const statusEl = document.getElementById('gh-test-status');
      statusEl.innerHTML='';
      if(!name){ alert('Name is required'); return; }
      if(!/^\S+\/\S+$/.test(full)){ alert("Repository must be 'owner/repo'"); return; }
      try{
        const fd = new FormData(); fd.append('full_name', full); fd.append('token', token); if(api) fd.append('api_base', api);
        const res = await fetch(withV2(`/setup/test-params/github`), {method:'POST', body: fd});
        const j = await res.json();
        if(j.ok){
          statusEl.innerHTML = `<span class="badge bg-success">OK</span>`;
          document.getElementById('btn-gh-save').disabled = false;
        } else {
          statusEl.innerHTML = `<span class="badge bg-danger">Fail</span> <small class="text-danger ms-1">${j.info || j.status || j.error || ''}</small>`;
          document.getElementById('btn-gh-save').disabled = true;
        }
      }catch(e){
        statusEl.innerHTML = `<span class="badge bg-danger">Error</span> <small class="text-danger ms-1">${e}</small>`;
        document.getElementById('btn-gh-save').disabled = true;
      }
    });
  }
});
</script>

{% endblock %}
